<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Login - Arvion Ad Screen</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-container {
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      max-width: 440px;
      width: 100%;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .logo-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px 30px;
      text-align: center;
    }

    .logo-section img {
      max-width: 280px;
      height: auto;
      filter: brightness(0) invert(1);
    }

    .form-section {
      padding: 40px 35px;
    }

    h2 {
      color: #2d3748;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
    }

    .subtitle {
      color: #718096;
      font-size: 14px;
      text-align: center;
      margin-bottom: 30px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      color: #4a5568;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: #f7fafc;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      background: #ffffff;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    #msg {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
      display: none;
    }

    #msg.error {
      background: #fed7d7;
      color: #c53030;
      border: 1px solid #fc8181;
      display: block;
    }

    #msg.success {
      background: #c6f6d5;
      color: #2f855a;
      border: 1px solid #9ae6b4;
      display: block;
    }

    #msg.info {
      background: #bee3f8;
      color: #2c5282;
      border: 1px solid #90cdf4;
      display: block;
    }

    @media (max-width: 480px) {
      .logo-section {
        padding: 30px 20px;
      }

      .form-section {
        padding: 30px 25px;
      }

      h2 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="logo-section">
      <img src="arvion_word_only_clean.png" alt="Arvion Logo" />
    </div>
    
    <div class="form-section">
      <h2>Welcome Back</h2>
      <p class="subtitle">Sign in to access your ad screen</p>
      
      <form id="loginForm">
        <div class="input-group">
          <label for="username">Username</label>
          <input id="username" type="text" placeholder="Enter your username" required autocomplete="username" />
        </div>
        
        <div class="input-group">
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="Enter your password" required autocomplete="current-password" />
        </div>
        
        <button type="submit">Sign In</button>
        <div id="msg"></div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>

  <script>
  async function getDeviceInfo(){
    const ua = navigator.userAgent || '';
    const info = { model:null, platform:null, os:null, osVersion:null, browser:null, browserVersion:null, ua:ua };
    
    // Try User-Agent Client Hints API first (this gives real device info on modern browsers)
    if (navigator.userAgentData?.getHighEntropyValues){
      try {
        const hi = await navigator.userAgentData.getHighEntropyValues([
          'platform',
          'platformVersion',
          'model',
          'uaFullVersion',
          'architecture',
          'bitness',
          'fullVersionList'
        ]);
        
        console.log('Client Hints Data:', hi); // Debug log
        
        // Get platform and version from Client Hints (more accurate)
        if (hi.platform) {
          info.platform = hi.platform;
          if (hi.platform === 'Android') {
            info.os = 'Android';
            info.osVersion = hi.platformVersion || null;
          }
        }
        
        // Get actual device model from Client Hints
        if (hi.model && hi.model !== '') {
          info.model = hi.model;
          console.log('Model from Client Hints:', hi.model);
        }
        
        // Get browser info from Client Hints
        if (hi.fullVersionList && hi.fullVersionList.length > 0) {
          const mainBrowser = hi.fullVersionList.find(b => 
            b.brand.includes('Chrome') || b.brand.includes('Edge') || b.brand.includes('Opera')
          );
          if (mainBrowser) {
            info.browser = mainBrowser.brand;
            info.browserVersion = mainBrowser.version;
          }
        } else if (hi.uaFullVersion) {
          info.browserVersion = hi.uaFullVersion;
        }
      } catch(e){ 
        console.warn('User-Agent Client Hints failed:', e); 
      }
    }
    
    // Fallback to User-Agent string parsing if Client Hints didn't provide everything
    
    // Android detection
    if (/Android/i.test(ua) || info.os === 'Android') {
      if (!info.os) info.os = 'Android';
      
      // Extract Android version from UA if not already set
      if (!info.osVersion) {
        const versionMatch = ua.match(/Android[\s\/]?([\d.]+)/i);
        if (versionMatch) info.osVersion = versionMatch[1];
      }
      
      // Extract device model from UA if not already set by Client Hints
      if (!info.model || info.model === 'K' || info.model.length <= 2) {
        let deviceModel = null;
        
        // Pattern 1: Android X.X; MODEL Build/
        let match = ua.match(/Android[^;]*;\s*([^;)]+?)\s+Build/i);
        if (match && match[1]) deviceModel = match[1];
        
        // Pattern 2: Android X.X; MODEL)
        if (!deviceModel) {
          match = ua.match(/Android[^;]*;\s*([^;)]+)\)/i);
          if (match && match[1]) deviceModel = match[1];
        }
        
        // Pattern 3: (Linux; Android X.X; MODEL)
        if (!deviceModel) {
          match = ua.match(/\(Linux;\s*Android[^;]*;\s*([^)]+)\)/i);
          if (match && match[1]) deviceModel = match[1];
        }
        
        if (deviceModel) {
          deviceModel = deviceModel.trim();
          // Only use if it's not a generic placeholder
          if (deviceModel.length > 2 && deviceModel !== 'K') {
            deviceModel = deviceModel.replace(/^(SAMSUNG[\s-]?|SM-)/i, '');
            deviceModel = deviceModel.replace(/\s+Build.*$/i, '');
            info.model = deviceModel;
          }
        }
        
        // If still generic, use a descriptive name
        if (!info.model || info.model === 'K' || info.model.length <= 2) {
          info.model = 'Android Device (Privacy Mode)';
        }
      }
    }
    // iOS detection
    else if (/iPhone|iPad|iPod/i.test(ua)) {
      const iosMatch = ua.match(/\b(iPhone|iPad|iPod)\b.*?OS\s+([\d_]+)/i);
      if (iosMatch) {
        info.os = 'iOS';
        info.model = iosMatch[1];
        info.osVersion = iosMatch[2].replace(/_/g, '.');
      }
    }
    // Windows detection
    else if (/Windows NT/i.test(ua)) {
      info.os = 'Windows';
      const winMatch = ua.match(/Windows NT ([\d.]+)/i);
      if (winMatch) {
        const ntVersion = winMatch[1];
        const versionMap = {
          '10.0': '10/11', '6.3': '8.1', '6.2': '8', '6.1': '7'
        };
        info.osVersion = versionMap[ntVersion] || ntVersion;
      }
      info.model = 'Windows PC';
    }
    // macOS detection
    else if (/Macintosh/i.test(ua)) {
      info.os = 'macOS';
      const macMatch = ua.match(/Mac OS X ([\d_]+)/i);
      if (macMatch) info.osVersion = macMatch[1].replace(/_/g, '.');
      info.model = 'Mac';
    }
    // Linux detection (desktop only, after all mobile checks)
    else if (/Linux/i.test(ua)) {
      info.os = 'Linux';
      info.model = 'Linux PC';
    }
    // Fallback
    else {
      info.os = 'Unknown';
      info.model = navigator.platform || 'Unknown Device';
    }
    
    // Browser detection from UA string if not set
    if (!info.browser) {
      const browserPatterns = [
        { name: 'Edge', pattern: /Edg[e]?\/([\d.]+)/i },
        { name: 'Chrome', pattern: /Chrome\/([\d.]+)/i },
        { name: 'Firefox', pattern: /Firefox\/([\d.]+)/i },
        { name: 'Safari', pattern: /Version\/([\d.]+).*Safari/i },
        { name: 'Opera', pattern: /OPR\/([\d.]+)/i }
      ];
      
      for (const {name, pattern} of browserPatterns) {
        const match = ua.match(pattern);
        if (match) {
          info.browser = name;
          info.browserVersion = match[1];
          break;
        }
      }
    }
    
    console.log('Final Device Info:', info); // Debug log
    return info;
  }

  const form = document.getElementById('loginForm'), msg = document.getElementById('msg');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.className = 'info';
    msg.textContent = 'Signing in...';

    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    try {
      const { data, error } = await supabase.rpc('verify_user', { un: username, pwd: password });
      if (error) { 
        console.error(error); 
        msg.className = 'error';
        msg.textContent = 'Server error. Please try again.'; 
        return; 
      }
      if (!data || data.length === 0) { 
        msg.className = 'error';
        msg.textContent = 'Invalid username or password'; 
        return; 
      }

      const row = data[0];
      const loginId = row.login_id;
      if (!loginId) { 
        msg.className = 'error';
        msg.textContent = 'Login failed. Please try again.'; 
        return; 
      }

      const dev = await getDeviceInfo();
      const device_model = dev.model || dev.platform || dev.ua.slice(0,60);
      await supabase.from('login_history').update({
        user_name: username,
        device_model: device_model,
        user_agent: dev.ua,
        last_ping: new Date().toISOString()
      }).eq('id', loginId);

      sessionStorage.setItem('login_id', loginId);
      sessionStorage.setItem('logged_user', username);

      try {
        supabase.channel('login_updates').send({
          type: 'broadcast',
          event: 'login',
          payload: { login_id: loginId, username, ts: new Date().toISOString() }
        });
      } catch(e) { console.warn('broadcast login failed', e); }

      msg.className = 'success';
      msg.textContent = 'Login successful! Redirecting...';

      setTimeout(() => {
        if (row.role === 'admin') window.location.href = 'admin.html';
        else window.location.href = 'display.html';
      }, 500);
    } catch (err) {
      console.error(err);
      msg.className = 'error';
      msg.textContent = 'Network error. Please check your connection.';
    }
  });
  </script>
</body>
</html>
